<html lang="en">
<head>
<title>Demo using M2D2 : Lists - Advaced example</title>
<meta charset="UTF-8">
<meta name="HandheldFriendly" content="1">
<meta name="viewport" content="width=device-width, maximum-scale=1.0">
<meta name="theme-color" content="#333333">
<link rel="stylesheet" href="../css/examples.css" type="text/css" />
<style type="text/css">
    #list td:hover {
        cursor: pointer;
        background-color: #EEE;
    }
    #list .price {
        text-align: right;
        padding-right: 5px;
        white-space: nowrap;
    }
    #list .price:before {
        content : '$ ';
    }
    #list .item_id, #list .delete {
        text-align: center !important;
    }
    #list .delete, #list .name, #list .price {
        border-right: 1px solid #CCC;
        cursor: pointer;
    }
    #heads th {
        background-color: #DDD;
        padding: 5px;
        cursor: ns-resize;
    }
</style>
<script src="../../dist/m2d2.src.js" type="text/javascript"></script>
<!-- Import Demo menu: -->
<script src="../js/demo-links.js" type="text/javascript"></script>
<!--                   -->
<script type="text/javascript">
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
//On ready...
m2d2.ready($ => {
    // This example is to show how to generate lists using a function
    checkout = $("#checkout", {
        dataset : {
            sortedBy : ""
        },
        heads : {
            tr : {
                template : "th",
                items : [
                    { text : "ID", onclick: (ev) => checkout.sortTable(ev), css : "item_id" },
                    { text : "Item", onclick: (ev) => checkout.sortTable(ev), css : "name" },
                    { text : "Price", onclick: (ev) => checkout.sortTable(ev), css : "price" },
                    { text : "Del" }
                ]
            }
        },
        list : {
            template: {
                tr: {
                    item_id: {
                        tagName: "td",
                        css: "item_id",
                        width: "5%",
                        text: "",
                        onclick: function (event) {
                            const td = event.target;
                            const id = td.parentNode.dataset.id;
                            let newId = prompt("Please enter new item ID: ", td.text);
                            if (newId) {
                                checkout.list.items.get(id).item_id.text = newId;
                            }
                        }
                    },
                    name: {
                        tagName: "td",
                        css: "name",
                        title: "Change Item",
                        width: "84%",
                        onclick: function (event) {
                            const td = event.target;
                            const id = td.parentNode.dataset.id;
                            let newName = prompt("Please enter new item name: ", td.text);
                            if (newName) {
                                checkout.list.items.get(id).name.text = newName;
                            }
                        }
                    },
                    price: {
                        tagName: "td",
                        css: "price",
                        title: "Change price",
                        width: "10%",
                        onclick: function (event) {
                            const td = event.target;
                            const id = td.parentNode.dataset.id;
                            let newPrice = prompt("Please enter new price: ", td.text);
                            if (newPrice) {
                                checkout.list.items.get(id).price.text = newPrice;
                            }
                        }
                    },
                    delete: {
                        tagName: "td",
                        css: "delete",
                        title: "Delete Item",
                        text: "âœ–",
                        width: "1%",
                        onclick: function (event) {
                            const td = event.target;
                            const id = td.parentNode.dataset.id;
                            checkout.list.items.remove(id);
                        }
                    }
                }
            },
            items: [],
        },
        sortTable : function(ev) {
            const th = ev.target;
            const label = th.text;
            const prop = th.css[0];
            const compare = ( a, b ) => {
                const x = a[prop].text.padStart(10, "0");
                const y = b[prop].text.padStart(10, "0");
                return x < y ? -1 : (x > y ? 1 : 0)
            }
            if(checkout.dataset.sortedBy === label) {
                list.items.reverse();
            } else {
                checkout.dataset.sortedBy = label;
                list.items.sort(compare);
            }
        }
    });

    (async() => {
        // Simulating loading data from remote server:
        // let response = await fetch("/some.service"); // Something like that
        // let data = await response.json();
        await sleep(1000);
        const data = [
            {
                id : "it1",
                item_id: "DB001",
                price: 100,
                name: "Doggy Bag",
                style : { color: "#713c3c" },
            }, {
                id : "it2",
                item_id: "SB002",
                price: 200,
                name: "Skateboard",
                style : { color: "#3c7141" },
            }, {
                id : "it3",
                item_id: "DH003",
                price: 150,
                name: "Doll House",
                style : { color: "#3c7141" },
            }, {
                id : "it4",
                item_id: "BG004",
                price: 125,
                name: "Board Game",
                style : { color: "#3c4133" },
            }, {
                id : "it5",
                item_id: "SP005",
                price: 500,
                name: "Sassy Pants",
                style : { color: "#AA3f71" },
            }, {
                id : "it6",
                item_id: "SB006",
                price: 350,
                name: "Soccer Ball",
                style : { color: "#3cAA71" },
            }, {
                id : "it7",
                item_id: "RR007",
                price: 425,
                name: "Red Rocket",
                style : { color: "#3c3fAA" },
            }, {
                id : "it8",
                item_id: "BG008",
                price: 50,
                name: "Bubble Gum",
                style : { color: "#3c0071" },
            }, {
                id : "it9",
                item_id: "GC009",
                price: 550,
                name: "Game Console",
                style : { color: "#3c3f00" },
            }
        ];
        // "actions" object can be used here because by this time it has been already initialized.
        actions.add.disabled = false;
        loading.show = false;
        checkout.list.items = data; // We could push each item in data, but this way renders faster
    })()

    let count = 0;
    // Action buttons:
    actions = $("#actions", {
		add : {
			disabled : true,
			onclick : function(ev) {
                const colors = [];
                for(let c=0; c<3; c++) {
                    colors.push(Math.round(Math.random() * 255));
                }
				checkout.list.items.push({
				  item_id : "EX" + ((list.items.length + 1) + "").padStart(3, "0"),
				  price : Math.round((Math.random() * 100000 / 100)),
				  name  : "Extra Item " + (++count),
				  style : { color : "rgb("+colors[0]+","+colors[1]+","+colors[2]+")" }
				});
                checkout.dataset.sortedBy = "";
			}
		}
    });
	loading = $("#loading", {
		show : true
	});
});
</script>
</head>
<body>
<article>
    <h1>M2D2 List example</h1>
    <p>This example loads the list using an async function. Then allows you to add or remove items as you want.</p>
    <p>You can click on the fields to change them.</p>
    <table id="checkout">
      <caption>My wish list:</caption>
      <thead id="heads"></thead>
      <tbody id="list"></tbody>
    </table>
    <div id="loading">Loading... (Simulating slow connection)</div>
    <div id="actions" class="controls">
        <div>
            <button class="add">Add Row</button>
        </div>
    </div>
</article>
</body>
</html>
