/**
 * Author : A.Lepe (dev@alepe.com) - intellisrc.com
 * License: MIT
 * Version: 2.1.7
 * Updated: 2024-02-19
 * Content: Extension
 */

m2d2.load((e=>{function n(e,n,o){const l=[];return e=e||{},n.forEach((r=>{const t="Array"==typeof e?e.length==n.length?e[o]:e:void 0!==e[r.name]?e[r.name]:e;l.push({file:r,data:t,index:o++})})),l}function o(e,n,o,l,r){const t=new XMLHttpRequest;n=Array.from(n),t.upload.addEventListener("progress",(function(e){if(e.lengthComputable)if(l.parallel){const r=Math.round(100*e.loaded/e.total);l.onUpdate(r,n[0],o)}else{let o=0,r=0;n.some((n=>{o+=n.size;const t=e.loaded>=o?100:100-Math.round(100*(o-e.loaded)/n.size);return l.onUpdate(t,n,r++),o>=e.loaded}))}}),!1),t.addEventListener("load",(function(e){let a={};try{a=t.responseText?JSON.parse(t.responseText):{error:{type:"Unknown",reason:"Unknown Error"}}}catch(e){a.error={type:"Parse Error",reason:e.message}}t.status>=200&&t.status<400?r(l.onResponse(a),n,o):("string"==typeof a.error&&(a.error={type:"Exception",reason:a.error}),l.onError(a.error))}),!1),t.open("POST",l.upload);const a=Array(n.length).fill(!1),s=function(e,n){const o=new FormData;return n.forEach((n=>{n&&o.append(e,n,n.name)})),o}(e,n);let i=0;n.forEach((e=>{if(e){const n=new FileReader;n.onload=function(e){a[i++]=!0,-1===a.indexOf(!1)&&t.send(s)},n.readAsBinaryString(e)}}))}e.upload=function(e,l){const r=Object.assign({},{upload:"",args:{},accept:"*/*",parallel:!1,field:"file",multiple:!0,maxFiles:0,maxParallel:0,maxSizeMb:0},l);l=null;let t=window._protected_reference=document.createElement("INPUT");t.name=r.field,t.type="file",1==r.multiple&&(t.multiple="multiple"),r.upload||(console.log("Upload not specified. Using current page."),r.upload="");const a=r.args?(-1!==r.upload.indexOf("?")?"&":"?")+new URLSearchParams(r.args).toString():"";r.upload+=a,null==r.onDone&&(r.onDone=(e,n)=>{console.log(e)}),null==r.onError&&(r.onError=e=>{console.log("Error : "),console.log(e)}),null==r.onUpdate&&(r.onUpdate=(e,n,o)=>{console.log("Uploading : "+e+"% "+(r.parallel?"[ "+n.name+" ]":""))}),null==r.onResponse&&(r.onResponse=e=>e),t.addEventListener("change",(()=>{if(t.files.length){if(!(0===r.maxFiles|t.files.length<=r.maxFiles))return r.onError("Max file limit exceeded. Maximum files: "+r.maxFiles),!1;if(r.onSelect){const e=[];let n=0;Array.from(t.files).forEach((o=>{e.push(URL.createObjectURL(o)),n+=o.size}));const o=n/1048576;if(r.maxSizeMb&&o>r.maxSizeMb)return r.onError("Maximum size exceeded: "+Math.ceil(o)+"MB > "+r.maxSizeMb+"MB"),!1;r.onSelect(t.files,e)}new Promise((e=>{if(r.parallel){let l=0;const a=Array.from(t.files),s=Array(a.length).fill(!1);let i=[];const c=function(a){new o(t.name,[a],l++,r,((o,l,t)=>{s[t]=!0,i.length&&(delete i[i.indexOf(a)],i=i.filter((e=>0===e||e)));const c=-1===s.indexOf(!1);r.onDone(n(o,l,t),c),c&&e()}))};if(r.maxParallel){const e=setInterval((()=>{if(0===a.length)clearInterval(e);else for(;i.length<1*r.maxParallel;){const e=a.shift();i.push(e),c(e)}}),100)}else a.forEach(c)}else new o(t.name,t.files,0,r,((o,l,t)=>{r.onDone(n(o,l,t),!0),e()}))})).then((()=>{t=window._protected_reference=void 0}))}})),t.click()}}));
//# sourceMappingURL=m2d2.upload.min.js.map
