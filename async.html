<html>
<head>
<title>Demo using M2D2 : Async</title>
<meta name="HandheldFriendly" content="1">
<meta name="viewport" content="width=device-width, maximum-scale=1.0">
<meta name="theme-color" content="#333333">
<link rel="stylesheet" href="css/common.css" type="text/css" />
<link rel="stylesheet" href="css/index.css" type="text/css" />
<script src="js/xhr.js" type="text/javascript"></script>
<script src="js/m2d2.min.js" type="text/javascript"></script>
<!-- Import Demo menu: -->
<script src="js/demo-links.js" type="text/javascript"></script>
<!--                   -->
<script type="text/javascript">
	//On ready..
	document.addEventListener("DOMContentLoaded", function() {
        // Showing when it is loading
        const loading = m2d2("#loading", {
            show : false
        });
        // This example uses the content inside <select> as template, which is an <option> tag.
        const users = m2d2("#users", function(callback) {
            loading.show = true;
            getXHR("https://jsonplaceholder.typicode.com/users",function(json) {
                const usersList = [];
                for(let u in json) {
                    const usr = json[u];
                    usersList.push({
                        id		: "usr-" + usr.id,
                        text	: usr.username,
                        value	: usr.id
                    });
                }
                loading.show = false;
                callback(usersList);
            });
            // Specify initial state and events:
            return {
                disabled : true,
                onchange : function(event) {
                    user.m2d2.update(this.value);
                },
                // Special events:
                oninit  : function() {
                    loading.show = true;
                    console.log("initializing...");
                },
                onrender: function() {
                    loading.show = false;
                    console.log("done.");
                }
            }
        });
		// This is similar to "timer" example, but using a remote server and
		// it will use a parameter when updating
		const user = m2d2("#user", function(callback, param) {
			if(param === undefined) param = 1;
            if(param !== 0) {
                //loading.show = true;
                //users.disabled = true;
                getXHR("https://jsonplaceholder.typicode.com/users?id="+param,function(json) {
                    json = json[0]; //get the first item
                    loading.show = false;
                    users.disabled = false;
                    callback({
                        user : json.username,
                        name : json.name,
                        email: json.email,
                        zip  : json.address.zipcode,
                        url  : {
                            a:  {
                                href : "http://" + json.website,
                                text : json.website,
                                target : "_blank"
                            }
                        }
                    });
                });
            }
		});
	});
</script>
</head>
<body>
<h1>M2D2 Async examples</h1>
<table id="user">
  <caption>User Info:</caption>
  <tr><th>Username</th><td class="user"></td></tr>
  <tr><th>Name</th><td class="name"></td></tr>
  <tr><th>E-Mail</th><td class="email"></td></tr>
  <tr><th>Zip Code</th><td class="zip"></td></tr>
  <tr><th>Website</th><td class="url"></td></tr>
</table>
<div id="loading">Loading...</div>
<div class="controls">
    <div><label for="users">User: </label>
		<select id="users">
			<option value="0">Choose one:</option>
		</select>
	</div>
</div>
</body>
</html>
